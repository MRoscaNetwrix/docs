"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[939951],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var r=n(296540);const s={},i=r.createContext(s);function o(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:t},e.children)}},461109:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"threatprevention/admin/templates/folder/scripts/passwordrejection","title":"Password Rejection Custom Script","description":"The following C# script sends an email notification to the specified perpetrator when their Active Directory password is rejected by the active Password Rules Filter criteria.","source":"@site/docs/threatprevention/threatprevention/admin/templates/folder/scripts/passwordrejection.md","sourceDirName":"threatprevention/admin/templates/folder/scripts","slug":"/threatprevention/admin/templates/folder/scripts/passwordrejection","permalink":"/docs/threatprevention/threatprevention/admin/templates/folder/scripts/passwordrejection","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/threatprevention/threatprevention/admin/templates/folder/scripts/passwordrejection.md","tags":[],"version":"current","frontMatter":{},"sidebar":"threatPreventionSidebar","previous":{"title":"Password Never Expires Custom Script","permalink":"/docs/threatprevention/threatprevention/admin/templates/folder/scripts/passwordneverexpires"},"next":{"title":"SIEM Folder Templates","permalink":"/docs/threatprevention/threatprevention/admin/templates/folder/siem"}}');var s=n(474848),i=n(28453);const o={},a="Password Rejection Custom Script",l={},c=[];function p(e){const t={a:"a",code:"code",em:"em",h1:"h1",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"password-rejection-custom-script",children:"Password Rejection Custom Script"})}),"\n",(0,s.jsxs)(t.p,{children:["The following C# script sends an email notification to the specified perpetrator when their Active Directory password is rejected by the active ",(0,s.jsx)(t.a,{href:"/docs/threatprevention/threatprevention/admin/policies/eventtype/passwordenforcement#password-rules-filter",children:"Password Rules Filter"})," criteria."]}),"\n",(0,s.jsx)(t.p,{children:"The following environmental variables must be added to the script prior to execution:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"SMTPHOST \u2013 Name of the organization\u2019s SMTP server"}),"\n",(0,s.jsx)(t.li,{children:"SMTPPORT \u2013 Port used by the organization\u2019s SMTP server"}),"\n",(0,s.jsxs)(t.li,{children:["SMTPENABLESSL \u2013 Indicates whether SSL is enabled or disabled on the SMTP server","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"False = Do not use SSL"}),"\n",(0,s.jsx)(t.li,{children:"True = Use SSL"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"SMTPFROM \u2013 Valid email account sending the email to the recipient"}),"\n",(0,s.jsx)(t.li,{children:"SMTPID \u2013 Valid username for SMTP server within the user's environment"}),"\n",(0,s.jsx)(t.li,{children:"SMTPPwD \u2013 Valid password for the username above"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["In the Templates > Actions folder in the Navigation pane, the ",(0,s.jsx)(t.em,{children:"EPE: Notify Perpetrator that password was rejected"})," template is preconfigured to use this action script."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"javascript:void(0);",children:"Copy"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'namespace ScriptNamespace  \n{  \nusing System;  \nusing System.Collections;  \nusing System.IO;  \nusing System.Text;  \nusing SI.Common.Messages;  \nusing SI.SIMonitor.ConsoleMessages.Helpers;  \nusing System.Net.Mail;  \nusing System.DirectoryServices;\xa0  \npublic class ScriptClass  \n{  \nprivate const string SMTPHOST = "mail.MyDomain.com";  \nprivate const int SMTPPORT = 25;  \nprivate const bool SMTPENABLESSL = false;  \nprivate const bool SMTPUSEDEFAULTCREDENTIALS = true;  \nprivate const bool SMTPHTML = true;  \nprivate const string SMTPFROM = "From@MyDomain.by";  \nprivate const string SMTPSUBJECT = "Password was rejected by EPE policy";  \nprivate const string SMTPID = "username";  \nprivate const string SMTPPWD = "password";  \nprivate const string EmailAttribute = "mail";  \nprivate EventConsumerHelper helper = null;\xa0  \n/// Required class constructor  \npublic ScriptClass(EventConsumerHelper ecHelper)  \n{  \nthis.helper = ecHelper;  \n}\xa0  \npublic virtual void ScriptMain()  \n{  \nstring SMTPTO = GetStringAttribute(helper.Perpetrator, EmailAttribute);  \nif (string.IsNullOrEmpty(SMTPTO))  \nthrow new Exception("AD attribute \'email\' is empty");\xa0  \nMailMessage msg = new MailMessage();  \nmsg.From = new MailAddress(SMTPFROM);  \nmsg.To.Add(SMTPTO);  \nmsg.Priority = MailPriority.High;  \nmsg.Subject = SMTPSUBJECT;\xa0  \nStringBuilder sb = new StringBuilder();  \nsb.AppendLine("<html>");  \nsb.AppendLine("<body>");  \nsb.AppendLine(String.Format("EventName: {0}<br>", helper.EventName));  \nsb.AppendLine(String.Format("EventNameTranslated: {0}<br>", helper.EventNameTranslated));  \nsb.AppendLine(String.Format("TimeLoggedUtc: {0}<br>", helper.TimeLoggedUtc.ToString("MMMM d, yyyy h:mm:ss tt")));  \nsb.AppendLine(String.Format("DN: {0}<br>", helper.Perpetrator));  \nsb.AppendLine(String.Format("Perpetrator: {0}<br>", helper.PerpetratorName));  \nsb.AppendLine("</body>");  \nsb.AppendLine("</html>");  \nstring body = sb.ToString();  \nmsg.Body = body;  \nmsg.IsBodyHtml = SMTPHTML;  \nSmtpClient client = new SmtpClient();  \nclient.Host = SMTPHOST;  \nclient.Port = SMTPPORT;  \nclient.EnableSsl = SMTPENABLESSL;  \nclient.UseDefaultCredentials = SMTPUSEDEFAULTCREDENTIALS;  \nif (!SMTPUSEDEFAULTCREDENTIALS)  \n{  \nclient.Credentials = new System.Net.NetworkCredential(SMTPID, SMTPPWD);  \n}  \nclient.DeliveryMethod = SmtpDeliveryMethod.Network;  \nclient.Send(msg);  \n}  \nprivate string GetStringAttribute(string dn, string AttributeName)  \n{  \nstring result = string.Empty;  \ntry  \n{  \nDirectoryEntry root = new DirectoryEntry();  \nusing (DirectorySearcher searcher = new DirectorySearcher(root))  \n{  \nsearcher.Filter = "(distinguishedName=" + dn + ")";  \nsearcher.PropertiesToLoad.Clear();  \nsearcher.ReferralChasing = ReferralChasingOption.All;  \nsearcher.PropertiesToLoad.Add(AttributeName);  \nsearcher.ClientTimeout = new TimeSpan(0, 0, 10);\xa0  \nvar searchResult = searcher.FindOne();  \nif (searchResult != null)  \n{  \nif (searchResult.Properties.Contains(AttributeName))  \n{  \nresult = searchResult.Properties[AttributeName][0] as string;  \n}  \n}  \n}  \n}  \ncatch { }  \nreturn result;  \n}  \n}  \n}\n'})})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}}}]);