"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[116266],{28453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>o});var t=n(296540);const i={},a=t.createContext(i);function r(e){const s=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(a.Provider,{value:s},e.children)}},90394:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/873_2_image-20211130233051-2-692b0d076ed58de116d4a09e79060b11.webp"},97337:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"policypak/troubleshooting/leastprivilege/kaseyaagentservice","title":"How-to troubleshoot LPM rules for Kaseya Agent Service?","description":"It seems that the Kaseya Agent service starts before the Netwrix Endpoint Policy Manager (formerly PolicyPak) services, which means Endpoint Policy Manager never witnesses Kaseya Agent Service (AgentMon.exe) spawning, so LPM never evaluates if it matches any defined policy.","source":"@site/docs/policypak/policypak/troubleshooting/leastprivilege/kaseyaagentservice.md","sourceDirName":"policypak/troubleshooting/leastprivilege","slug":"/policypak/troubleshooting/leastprivilege/kaseyaagentservice","permalink":"/docs/policypak/policypak/troubleshooting/leastprivilege/kaseyaagentservice","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/policypak/policypak/troubleshooting/leastprivilege/kaseyaagentservice.md","tags":[],"version":"current","frontMatter":{},"sidebar":"policyPakSidebar","previous":{"title":"Why is my File Info Deny rule for WinSCP Setup 17.x and lower not working?","permalink":"/docs/policypak/policypak/troubleshooting/leastprivilege/fileinfodeny/winscp"},"next":{"title":"Troubleshooting","permalink":"/docs/policypak/policypak/troubleshooting/leastprivilege/overview"}}');var i=n(474848),a=n(28453);const r={},o="How-to troubleshoot LPM rules for Kaseya Agent Service?",c={},l=[];function p(e){const s={code:"code",h1:"h1",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"how-to-troubleshoot-lpm-rules-for-kaseya-agent-service",children:"How-to troubleshoot LPM rules for Kaseya Agent Service?"})}),"\n",(0,i.jsx)(s.p,{children:"It seems that the Kaseya Agent service starts before the Netwrix Endpoint Policy Manager (formerly PolicyPak) services, which means Endpoint Policy Manager never witnesses Kaseya Agent Service (AgentMon.exe) spawning, so LPM never evaluates if it matches any defined policy."}),"\n",(0,i.jsx)(s.p,{children:'The owner of the "AgentMon.exe" is on the SecureRun list, the service can start, but then there it isn\'t matching the policy which would allow it to spawn child processes that are allowed.'}),"\n",(0,i.jsx)(s.p,{children:"We are going to make the Kaseya service depend on the Endpoint Policy Manager services."}),"\n",(0,i.jsx)(s.p,{children:"Since we only need to do this if Endpoint Policy Manager exists, we'll use Endpoint Policy Manager Script Manager to run a PowerShell script to enable the service dependencies (if Kaseya also exists)."}),"\n",(0,i.jsx)(s.p,{children:"Upon rebooting the machine all of the Kaseya actions should match the created policies and child processes are allowed as intended."}),"\n",(0,i.jsx)(s.p,{children:"PS:\xa0Kaseya Agent service' display name should be same as in the script. Please confirm and edit if it's different in your environment."}),"\n",(0,i.jsx)(s.p,{children:"Steps:"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 1 \u2013"})," Create a Endpoint Policy Manager Scripts Manager policy under Computer container"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"873_1_image-20211130233051-1",src:n(239908).A+"",width:"814",height:"337"})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 2 \u2013"})," Select PowerShell script from the drop-down at On apply action window and paste the PowerShell script from below."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"873_2_image-20211130233051-2",src:n(90394).A+"",width:"814",height:"843"})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 3 \u2013"})," Select \u2018Once or when forced' at Specify process mode window."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"873_3_image-20211130233051-3",src:n(462284).A+"",width:"854",height:"558"})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 4 \u2013"})," Finish the Wizard to complete the policy creation."]}),"\n",(0,i.jsx)(s.p,{children:"Optional:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Revert script when policy no longer applies or you do not need Endpoint Policy Manager services dependencies for Kaseya Agent Service."}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"873_4_image-20211130233051-4",src:n(510374).A+"",width:"816",height:"406"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"***** Powershell 'apply' script:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:'$svcKaseya = (Get-Service -DisplayName "Kaseya Agent" | Select -Property Name).Name  \n$svcPPHelper = "PPExtensionSvc*"  \n$svcPPWatcher = "PPWatcherSvc*"  \nif ($svc = @(get-service $svcKaseya -ea 0)) {  \n# if Kaseya Service has no dependents currently  \nif (-not $svc.ServicesDependedOn) {  \n# Build the list of PolicyPak service names  \n$svcListPP = @()  \nif ($svc = @(get-service $svcPPHelper -ea 0)) {  \nforeach ($s in $svc.Name) {  \n$svcListPP += $s  \n}  \n}  \nif ($svc = @(get-service $svcPPWatcher -ea 0)) {  \nforeach ($s in $svc.Name) {  \n$svcListPP += $s  \n}  \n}  \n$svcListPP = $svcListPP -join "/"  \n# Set the Kaseya service to depend on the PolicyPak services  \n& cmd /c sc config $svcKaseya depend= $svcListPP  \n# Restart the kaseya agent service  \nRestart-Service $svcKaseya  \n}  \n}\n'})}),"\n",(0,i.jsx)(s.p,{children:"******Powershell \u2018revert' script:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:'$svcKaseya = (Get-Service -DisplayName "Kaseya Agent" | Select -Property Name).Name  \n& cmd /c sc config $svcKaseya depend= /\n'})})]})}function d(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},239908:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/873_1_image-20211130233051-1-fa7e2248fde1b769c5988064ab6f97fb.webp"},462284:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/873_3_image-20211130233051-3-41658314c1fc979514e5c14027e39e9d.webp"},510374:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/873_4_image-20211130233051-4-2c33f003e5125212c9c3d9c06b5e5f13.webp"}}]);