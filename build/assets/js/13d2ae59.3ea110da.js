"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[730173],{28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var i=t(296540);const r={},o=i.createContext(r);function s(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(o.Provider,{value:n},e.children)}},911880:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"configuration/exchangeonlinenonowner","title":"Settings for Non-Owner Mailbox Access Audit: Using Application","description":"To prepare for non-owner mailbox access auditing in the Exchange Online organization, you will need to take several configuration steps, creating a Microsoft Entra ID app with the required permissions and instructing this app to automatically apply the necessary audit settings.","source":"@site/docs/1secure/configuration/exchangeonlinenonowner.md","sourceDirName":"configuration","slug":"/configuration/exchangeonlinenonowner","permalink":"/docs/1secure/configuration/exchangeonlinenonowner","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/1secure/configuration/exchangeonlinenonowner.md","tags":[],"version":"current","frontMatter":{},"sidebar":"oneSecureSidebar","previous":{"title":"App Registration and Configuration in Microsoft Entra ID","permalink":"/docs/1secure/configuration/entraid/registerconfig"},"next":{"title":"Configure Advanced Audit Policies","permalink":"/docs/1secure/configuration/logonactivity/advancedaudit"}}');var r=t(474848),o=t(28453);const s={},a="Settings for Non-Owner Mailbox Access Audit: Using Application",c={},l=[{value:"Grant Permissions to the Application",id:"grant-permissions-to-the-application",level:2},{value:"Grant Required Roles",id:"grant-required-roles",level:2},{value:"Set Up an Environment",id:"set-up-an-environment",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"settings-for-non-owner-mailbox-access-audit-using-application",children:"Settings for Non-Owner Mailbox Access Audit: Using Application"})}),"\n",(0,r.jsx)(n.p,{children:"To prepare for non-owner mailbox access auditing in the Exchange Online organization, you will need to take several configuration steps, creating a Microsoft Entra ID app with the required permissions and instructing this app to automatically apply the necessary audit settings."}),"\n",(0,r.jsx)(n.p,{children:"These settings shall provide configuration for the All Exchange Online Non-Owner Mailbox Access Events report. See the Filters topic for additional information."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"NOTE:"})," To start auditing the data for the report, you need to select the ",(0,r.jsx)(n.strong,{children:"Collect non-owner mailbox audit data"})," check box when adding the Exchange Online source. See the ",(0,r.jsx)(n.a,{href:"/docs/1secure/admin/organizations/sourcesandconnectors/exchangeonline",children:"Add a Source and Connectors for Exchange Online"}),"topic for additional information."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"NOTE:"})," Unified audit log must be enabled for a tenant. See the Microsoft ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/purview/audit-log-enable-disable?view=o365-worldwide&tabs=microsoft-purview-portal",children:"Turn auditing on or off"})," article for additional information."]}),"\n",(0,r.jsx)(n.h2,{id:"grant-permissions-to-the-application",children:"Grant Permissions to the Application"}),"\n",(0,r.jsx)(n.p,{children:"Follow the steps to grant permissions to the Microsoft Entra ID application."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"NOTE:"})," The steps below are for registering an app through the Microsoft Entra admin center. These steps may vary slightly if you use a different Microsoft portal. See the relevant Microsoft documentation for additional information."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 1 \u2013"})," In the Microsoft Entra admin center, create and register a Microsoft Entra ID app. See the"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 2 \u2013"})," After you created an app, select the newly-created, registered application. If you left the Overview page, it will be listed in the ",(0,r.jsx)(n.strong,{children:"Identity"})," > ",(0,r.jsx)(n.strong,{children:"Applications"})," > ",(0,r.jsx)(n.strong,{children:"App registrations"})," > ",(0,r.jsx)(n.strong,{children:"All applications"})," list."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 3 \u2013"})," On the registered app blade, click ",(0,r.jsx)(n.strong,{children:"API permissions"})," in the Manage section."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 4 \u2013"})," In the top toolbar, click ",(0,r.jsx)(n.strong,{children:"Add a permission"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 5 \u2013"})," On the Request API permissions blade, click the ",(0,r.jsx)(n.strong,{children:"APIs my organization uses"})," tab and search for ",(0,r.jsx)(n.em,{children:"Office 365 Exchange Online"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 6 \u2013"})," Click on the ",(0,r.jsx)(n.em,{children:"Office 365 Exchange Online"})," entry in the list of apps found."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 7 \u2013"}),"\nProceed with adding the permissions for this app: select ",(0,r.jsx)(n.strong,{children:"Application permissions"})," and then select ",(0,r.jsx)(n.strong,{children:"Exchange.ManageAsApp"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 8 \u2013"})," Click ",(0,r.jsx)(n.strong,{children:"Grant Admin Consent for [tenant]"}),". Then click ",(0,r.jsx)(n.strong,{children:"Yes"})," in the confirmation window."]}),"\n",(0,r.jsx)(n.p,{children:"The application is granted the required API permissions."}),"\n",(0,r.jsx)(n.h2,{id:"grant-required-roles",children:"Grant Required Roles"}),"\n",(0,r.jsx)(n.p,{children:"Follow the steps to grant roles to the registered application."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"NOTE:"})," The steps below are for registering an app through the Microsoft Entra admin center. These steps may vary slightly if you use a different Microsoft portal. See the relevant Microsoft documentation for additional information."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 1 \u2013"})," From the ",(0,r.jsx)(n.strong,{children:"Identity"})," > ",(0,r.jsx)(n.strong,{children:"Roles & admins"})," blade, click > ",(0,r.jsx)(n.strong,{children:"Roles & admins"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 2 \u2013"})," Search for the Exchange Administrator or the Global Administrator role."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 3 \u2013"})," On the Assignments page, click ",(0,r.jsx)(n.strong,{children:"Add assignments"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 4 \u2013"})," In the Add assignments layout, select the created application and click ",(0,r.jsx)(n.strong,{children:"Add"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"The application is granted the required roles."}),"\n",(0,r.jsx)(n.h2,{id:"set-up-an-environment",children:"Set Up an Environment"}),"\n",(0,r.jsx)(n.p,{children:"Follow the steps to set up your environment using PowerShell."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 1 \u2013"})," Install the Exchange Online PowerShell V2 module."]}),"\n",(0,r.jsxs)(n.p,{children:["Make sure you are using the version specified in the ",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/powershell/exchange/app-only-auth-powershell-v2?view=exchange-ps",children:"related Microsoft article"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 2 \u2013"})," Download the PowerShell script for certificate creation, as provided in the ",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/powershell/exchange/app-only-auth-powershell-v2?view=exchange-ps#microsoft-instruction",children:"Microsoft instruction"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 3 \u2013"})," To create a self-signed certificate to be used by the app, run the following command in Powershell:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'.\\Create-SelfSignedCertificate.ps1 -CommonName "MyCompanyName" -StartDate 2020-04-01 -EndDate 2022-04-01\n'})}),"\n",(0,r.jsx)(n.p,{children:"where:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CommonName"})," \u2014 specify ",(0,r.jsx)(n.em,{children:'"Netwrix 1Secure"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"StartDate"})," \u2014 set to current date"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"EndDate"})," \u2014 set to 2 years from now"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 4 \u2013"})," When prompted to specify a password, click ",(0,r.jsx)(n.strong,{children:"Enter"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 5 \u2013"})," Go to ",(0,r.jsx)(n.strong,{children:"Identity"})," > ",(0,r.jsx)(n.strong,{children:"Applications"})," > ",(0,r.jsx)(n.strong,{children:"App registrations"}),' > "your app" >  ',(0,r.jsx)(n.strong,{children:"Certificates & secrets"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 6 \u2013"})," Click ",(0,r.jsx)(n.strong,{children:"Upload certificate"})," and upload the_.crt_ file you have just created."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 7 \u2013"})," To create Exchange Online connection session, you can provide certificate file path or thumbprint. If you want to use a file path, run the following command in Powershell:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'Connect-ExchangeOnline -CertificateFilePath "full_path_to_certificate" -AppID "yourAppId" -Organization "Office365_tenant_name"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Application (client ID) can be found in the ",(0,r.jsx)(n.strong,{children:"Overview"})," page."]}),"\n",(0,r.jsx)(n.p,{children:"For example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'Connect-ExchangeOnline -CertificateFilePath "C:\\Path\\MyCompanyName1.pfx" -AppId "402b12a2-fb2b-4222-8f54-5596def1" -Organization "myorganization123.onmicrosoft.com"\n'})}),"\n",(0,r.jsx)(n.p,{children:"You can use certificate thumbprint instead of file path. For that, import the certificate to the local certificate store, using the following command in Powershell:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'Import-PfxCertificate -FilePath "path_to_pfx_certificate" -CertStoreLocation Cert:\\CurrentUser\\My\n'})}),"\n",(0,r.jsx)(n.p,{children:"Then run the command in Powershell like following:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Connect-ExchangeOnline -CertificateThumbprint 6AE\u04105A82911\u0410\u0410\u04103F76FEE149B7B52\u041070DDFD88 -AppId a14a 822d-f228-412b-9222-281de23 -Organization myorganization123.onmicrosoft.com\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 8 \u2013"})," To set up the audit, run the following command in Powershell:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Get-ExoMailbox -PropertySets Minimum -RecipientTypeDetails UserMailbox,SharedMailbox,EquipmentMailbox,LinkedMailbox,RoomMailbox | Set-Mailbox -AuditEnabled $true \u2013AuditAdmin Update,Copy,Move,MoveToDeletedItems,SoftDelete,HardDelete,FolderBind,SendAs,SendOnBehalf,Create \u2013AuditDelegate Update,Move,MoveToDeletedItems,SoftDelete,HardDelete,FolderBind,SendAs,SendOnBehalf,Create\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Step 9 \u2013"})," Finally, run the following command in Powershell to end the session:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Disconnect-ExchangeOnline -Confim:$False\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"NOTE:"})," To automate steps 8-9, you can create a script comprising the corresponding commands and schedule its launch."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);