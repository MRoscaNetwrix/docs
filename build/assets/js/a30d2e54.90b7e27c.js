"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[960007],{28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var r=t(296540);const i={},s=r.createContext(i);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:n},e.children)}},264571:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"threatprevention/admin/templates/folder/scripts/lockunlockaccount","title":"Lock and/or Unlock Account Custom Script","description":"The following C# script sends an email notification to the specified user when an Active Directory account is locked and/or unlocked.","source":"@site/docs/threatprevention/threatprevention/admin/templates/folder/scripts/lockunlockaccount.md","sourceDirName":"threatprevention/admin/templates/folder/scripts","slug":"/threatprevention/admin/templates/folder/scripts/lockunlockaccount","permalink":"/docs/threatprevention/threatprevention/admin/templates/folder/scripts/lockunlockaccount","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/threatprevention/threatprevention/admin/templates/folder/scripts/lockunlockaccount.md","tags":[],"version":"current","frontMatter":{},"sidebar":"threatPreventionSidebar","previous":{"title":"Account Enablement Custom Script","permalink":"/docs/threatprevention/threatprevention/admin/templates/folder/scripts/accountenablement"},"next":{"title":"Password Changes Custom Script","permalink":"/docs/threatprevention/threatprevention/admin/templates/folder/scripts/passwordchanges"}}');var i=t(474848),s=t(28453);const o={},a="Lock and/or Unlock Account Custom Script",c={},l=[];function d(e){const n={code:"code",em:"em",h1:"h1",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"lock-andor-unlock-account-custom-script",children:"Lock and/or Unlock Account Custom Script"})}),"\n",(0,i.jsx)(n.p,{children:"The following C# script sends an email notification to the specified user when an Active Directory account is locked and/or unlocked."}),"\n",(0,i.jsx)(n.p,{children:"The following environmental variables must be added to the script prior to execution:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"SMTPHOST \u2013 Name of the organization\u2019s SMTP server"}),"\n",(0,i.jsx)(n.li,{children:"SMTPPORT \u2013 Port used by the organization\u2019s SMTP server"}),"\n",(0,i.jsxs)(n.li,{children:["SMTPENABLESSL \u2013 Indicates whether SSL is enabled or disabled on the SMTP server","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"False = Do not use SSL"}),"\n",(0,i.jsx)(n.li,{children:"True = Use SSL"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"SMTPFROM \u2013 Valid email account sending the email to the recipient"}),"\n",(0,i.jsx)(n.li,{children:"SMTPID \u2013 Valid username for SMTP server within the user's environment"}),"\n",(0,i.jsx)(n.li,{children:"SMTPPwD \u2013 Valid password for the username above"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In the Templates > Actions folder in the Navigation pane, the ",(0,i.jsx)(n.em,{children:"AD Changes: Notify Admin that account was locked/unlocked"})," template is preconfigured to use this action script."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'namespace ScriptNamespace  \n{  \nusing System;  \nusing System.Collections;  \nusing System.IO;  \nusing System.Text;  \nusing SI.Common.Messages;  \nusing SI.SIMonitor.ConsoleMessages.Helpers;  \nusing System.Net.Mail;  \nusing System.DirectoryServices;\xa0  \npublic class ScriptClass  \n{  \nprivate const string SMTPHOST ="mail.MyDomain.com";  \nprivate const int SMTPPORT = 25";  \nprivate const book SMTPENABLESSL = false;  \nprivate const bool SMTPUSEDEFAULTCREDENTIALS = true;  \nprivate const bool SMTPHTML = true;  \nprivate const SMTPFROM ="From@MyDomain.by";  \nprivate const string SMTPID ="username";  \nprivate const string SMTPPWD = "password";  \nprivate EventConsumerHelper helper = null;  \nprivate const string kEmailAttribute = "mail"\xa0  \n/// Required class constructor  \npublic ScriptClass(EventConsumerHelper ecHelper)  \n{  \nthis.helper = ecHelper;  \n}\xa0  \npublic virtual void ScriptMain()  \n{  \nstring SMTPTO = GetStringAttribute(helper.DN, kEmailAttribute);  \nif (string.IsNullOrEmpty(SMTPTO))  \nthrow new Exception("AD attribute \'email\' is empty");\xa0  \nif (string.IsNullOrEmpty(helper.EventNameTranslated))  \nreturn;\xa0  \nif (!helper.EventNameTranslated.ToLower().Equals("account unlocked") &&  \n!helper.EventNameTranslated.ToLower().Equals("account locked"))  \nreturn;\xa0  \nMailMessage msg = new MailMessage();  \nmsg.From = new MailAddress(SMTPFROM);  \nmsg.To.Add(SMTPTO);  \nmsg.Priority = MailPriority.High;  \nmsg.Subject = helper.EventNameTranslated;\xa0  \nStringBuilder sb = new StringBuilder();  \nsb.AppendLine("<html>");  \nsb.AppendLine("<body>");  \nsb.AppendLine(String.Format("EventName: {0}<br>", helper.EventName));  \nsb.AppendLine(String.Format("EventNameTranslated: {0}<br>", helper.EventNameTranslated));  \nsb.AppendLine(String.Format("TimeLoggedUtc: {0}<br>", helper.TimeLoggedUtc.ToString("MMMM d, yyyy h:mm:ss tt")));  \nsb.AppendLine(String.Format("DN: {0}<br>", helper.DN));  \nsb.AppendLine(String.Format("Perpetrator: {0}<br>", helper.PerpetratorName));  \nsb.AppendLine("</body>");  \nsb.AppendLine("</html>");  \nstring body = sb.ToString();  \nmsg.Body = body;  \nmsg.IsBodyHtml = SMTPHTML;  \nSmtpClient client = new SmtpClient();  \nclient.Host = SMTPHOST;  \nclient.Port = SMTPPORT;  \nclient.EnableSsl = SMTPENABLESSL;  \nclient.UseDefaultCredentials = SMTPUSEDEFAULTCREDENTIALS;  \nif (!SMTPUSEDEFAULTCREDENTIALS)  \n{  \nclient.Credentials = new System.Net.NetworkCredential(SMTPID, SMTPPWD);  \n}  \nclient.DeliveryMethod = SmtpDeliveryMethod.Network;  \nclient.Send(msg);  \n}\xa0  \nprivate string GetStringAttribute(string dn, string AttributeName)  \n{  \nstring result = string.Empty;  \ntry  \n{  \nDirectoryEntry root = new DirectoryEntry();  \nusing (DirectorySearcher searcher = new DirectorySearcher(root))  \n{  \nsearcher.Filter = "(distinguishedName=" + dn + ")";  \nsearcher.PropertiesToLoad.Clear();  \nsearcher.ReferralChasing = ReferralChasingOption.All;  \nsearcher.PropertiesToLoad.Add(AttributeName);  \nsearcher.ClientTimeout = new TimeSpan(0, 0, 10);\xa0  \nvar searchResult = searcher.FindOne();  \nif (searchResult != null)  \n{  \nif (searchResult.Properties.Contains(AttributeName))  \n{  \nresult = searchResult.Properties[AttributeName][0] as string;  \n}  \n}  \n}  \n}  \ncatch { }  \nreturn result;  \n}  \n}  \n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);