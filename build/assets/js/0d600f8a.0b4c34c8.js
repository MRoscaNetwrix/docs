"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[422506],{28453:(e,n,o)=>{o.d(n,{R:()=>s,x:()=>a});var i=o(296540);const l={},t=i.createContext(l);function s(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),i.createElement(t.Provider,{value:n},e.children)}},68456:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>r});const i=JSON.parse('{"id":"policypak/leastprivilege/powershell/block","title":"How to Block running PowerShell 2.0 using Least Privilege Manager","description":"Issue:","source":"@site/docs/policypak/policypak/leastprivilege/powershell/block.md","sourceDirName":"policypak/leastprivilege/powershell","slug":"/policypak/leastprivilege/powershell/block","permalink":"/docs/policypak/policypak/leastprivilege/powershell/block","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/policypak/policypak/leastprivilege/powershell/block.md","tags":[],"version":"current","frontMatter":{},"sidebar":"policyPakSidebar","previous":{"title":"Least Privilege Manager - How to create a Self-Elevation policy for local groups of Standalone computers","permalink":"/docs/policypak/policypak/leastprivilege/policyeditor/selfelevation"},"next":{"title":"How to Defend against malicious PowerShell attacks (DLLs)?","permalink":"/docs/policypak/policypak/leastprivilege/powershell/maliciousattacks"}}');var l=o(474848),t=o(28453);const s={},a="How to Block running PowerShell 2.0 using Least Privilege Manager",c={},r=[];function p(e){const n={a:"a",code:"code",h1:"h1",header:"header",img:"img",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"how-to-block-running-powershell-20-using-least-privilege-manager",children:"How to Block running PowerShell 2.0 using Least Privilege Manager"})}),"\n",(0,l.jsx)(n.p,{children:"Issue:"}),"\n",(0,l.jsx)(n.p,{children:"Blocking PowerShell Version 2 using a traditional command line rule in Endpoint Policy Manager Least Privilege Manager results in multiple block events being generated every second in the Endpoint Policy Manager event log."}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{alt:"1319_1_61042bd4123a78ef7686b114b9eea335",src:o(613347).A+"",width:"1020",height:"604"})}),"\n",(0,l.jsx)(n.p,{children:"Cause:"}),"\n",(0,l.jsx)(n.p,{children:"When you try to run PowerShell -v 2 (or an equivalent) from the PowerShell prompt the following is happening:"}),"\n",(0,l.jsx)(n.p,{children:"First, the parent (PowerShell) creates a child with the following command line:"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"})," -version 2"]}),"\n",(0,l.jsx)(n.p,{children:"When it fails (due to the fact the PP LPM Client Side Extensions (CSE) blocks it), the parent (the initial PowerShell process) creates a temporary child process with another command line:"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"})," -version 2."]}),"\n",(0,l.jsx)(n.p,{children:"The child process then creates another child process with the initial command line and Endpoint Policy Manager (formerly PolicyPak) Least Privilege Managerblocks it."}),"\n",(0,l.jsx)(n.p,{children:"Then it repeats, in an endless loop."}),"\n",(0,l.jsx)(n.p,{children:"Workaround:"}),"\n",(0,l.jsx)(n.p,{children:"Since we cannot alter the internal PowerShell logic that attempts to restart the child process to overcome the failure, we have to use the two scripts below to work around the issue. The two policies below are also attached as XML for your convenience."}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{alt:"1319_2_d3a2208d260469bdbfdfc7edaf6848ba",src:o(955212).A+"",width:"872",height:"612"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{alt:"1319_3_5745adb2d8b01ee9555aa6db772eae6a",src:o(854974).A+"",width:"881",height:"620"})}),"\n",(0,l.jsx)(n.p,{children:"Lastly, test using the command directly below to ensure that PowerShell Version 2.0 is now successfully blocked and that there are no longer multiple block events being created in the Endpoint Policy Manager event log."}),"\n",(0,l.jsx)(n.p,{children:"PowerShell -version 2.0"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"javascript:void(0);",children:"Copy"})}),"\n",(0,l.jsx)(n.p,{children:"PowerShell V2 Workaround"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'<?xml version="1.0" encoding="utf-8"?>  \n<policy xmlns:lpm="http://www.policypak.com/2016/LPM/CommonTypes" xmlns:ext="http://www.policypak.com/2019/LPM/PolicyEntryExtension" xmlns:security="http://www.policypak.com/2016/LPM/Security" xmlns:pd="http://www.policypak.com/2014/Policies/PolicyData" xmlns:pp="http://www.policypak.com/2014/CommonTypes" id="{16bd96da-fbdf-41ee-b5c7-928c2f4d7bb4}" productId="{58DE0268-6384-49E0-A333-20EC46654B82}" scope="machine" timestamp="1695653890" xmlns="http://www.policypak.com/2016/LPM/PolicyData">  \n\xa0\xa0<collection order="0" id="{88ed31d2-b92b-455c-a430-df0ef4c628f0}" displayName="Collection for policy: Block Powershell by SIG and FILE INFO">  \n\xa0\xa0\xa0\xa0<entry order="0" scope="user" id="{cf4d5203-0b5e-4f34-a604-51eebf79f29a}" displayName="Block Powershell by SIG and FILE INFO (Rule 1)">  \n\xa0\xa0\xa0\xa0\xa0\xa0<rule-v1>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<executableRule xmlns="http://www.policypak.com/2016/LPM/Rules-V1">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<conditions xmlns="http://www.policypak.com/2016/LPM/ExecutableRule">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<signatureCondition xmlns="http://www.policypak.com/2016/LPM/Rules">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<commonName>CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US</commonName>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</signatureCondition>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<fileInfoCondition xmlns="http://www.policypak.com/2016/LPM/Rules">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<productName>Microsoft\xae Windows\xae Operating System</productName>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<productVersion mode="HigherOrEquals">10.0.14393.206</productVersion>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<fileName useWildcards="true">*powersh*</fileName>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<fileVersion mode="HigherOrEquals">10.0.14393.206</fileVersion>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</fileInfoCondition>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<commandLineCondition xmlns="http://www.policypak.com/2016/LPM/Rules">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<value>-v* 2*</value>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<useAndSpecifierForArguments>false</useAndSpecifierForArguments>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</commandLineCondition>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</conditions>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<settings justificationTextRequired="false" xmlns="http://www.policypak.com/2016/LPM/ExecutableRule">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<applyToChildProcesses>false</applyToChildProcesses>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</settings>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<action xmlns="http://www.policypak.com/2016/LPM/ExecutableRule">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<denyExecution xmlns="http://www.policypak.com/2016/LPM/Actions">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<useDefaultMessage>false</useDefaultMessage>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</denyExecution>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</action>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</executableRule>  \n\xa0\xa0\xa0\xa0\xa0\xa0</rule-v1>  \n\xa0\xa0\xa0\xa0</entry>  \n\xa0\xa0\xa0\xa0<entry order="1" scope="user" id="{3ef0d0a6-4c7a-4e77-8935-c564d55e6a7c}" displayName="Block Powershell by SIG and FILE INFO (Rule 2)">  \n\xa0\xa0\xa0\xa0\xa0\xa0<rule-v1>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<executableRule xmlns="http://www.policypak.com/2016/LPM/Rules-V1">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<conditions xmlns="http://www.policypak.com/2016/LPM/ExecutableRule">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<signatureCondition xmlns="http://www.policypak.com/2016/LPM/Rules">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<commonName>CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US</commonName>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</signatureCondition>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<fileInfoCondition xmlns="http://www.policypak.com/2016/LPM/Rules">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<productName>Microsoft\xae Windows\xae Operating System</productName>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<productVersion mode="HigherOrEquals">10.0.14393.206</productVersion>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<fileName useWildcards="true">*powersh*</fileName>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<fileVersion mode="HigherOrEquals">10.0.14393.206</fileVersion>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</fileInfoCondition>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<commandLineCondition xmlns="http://www.policypak.com/2016/LPM/Rules">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<value>* -v* 2*</value>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<useAndSpecifierForArguments>false</useAndSpecifierForArguments>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</commandLineCondition>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</conditions>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<settings justificationTextRequired="false" xmlns="http://www.policypak.com/2016/LPM/ExecutableRule">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<applyToChildProcesses>false</applyToChildProcesses>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</settings>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<action xmlns="http://www.policypak.com/2016/LPM/ExecutableRule">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<denyExecution xmlns="http://www.policypak.com/2016/LPM/Actions">  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0<useDefaultMessage>false</useDefaultMessage>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</denyExecution>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</action>  \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0</executableRule>  \n\xa0\xa0\xa0\xa0\xa0\xa0</rule-v1>  \n\xa0\xa0\xa0\xa0</entry>  \n\xa0\xa0</collection>  \n</policy>\n'})})]})}function d(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(p,{...e})}):p(e)}},613347:(e,n,o)=>{o.d(n,{A:()=>i});const i=o.p+"assets/images/1319_1_61042bd4123a78ef7686b114b9eea335-3e231b0c46de6fba9d717ccfddd7d099.webp"},854974:(e,n,o)=>{o.d(n,{A:()=>i});const i=o.p+"assets/images/1319_3_5745adb2d8b01ee9555aa6db772eae6a-928837c01ede504258d2995711357f79.webp"},955212:(e,n,o)=>{o.d(n,{A:()=>i});const i=o.p+"assets/images/1319_2_d3a2208d260469bdbfdfc7edaf6848ba-46160bc0ac8f48350c23f0f6e343e419.webp"}}]);