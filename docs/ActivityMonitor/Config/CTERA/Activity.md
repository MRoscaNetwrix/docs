# CTERA Activity Auditing Configuration

The Netwrix Activity Monitor can be configured to monitor file system activity on CTERA Edge Filer appliances.

The monitoring process relies on the SMB auditing feature of the CTERA Edge Filer. A local audit log file is generated by each Edge Filer and audit events from these files are collected by the CTERA Portal. The CTERA Portal forwards the events from the Edge Filers to the Activity Monitor Agent through the Messaging and Syslog services.

![Monitoring Process -CTERA Portal](/img/product_docs/activitymonitor/config/ctera/cterasyslogmsg.png)

To prepare CTERA for monitoring:

- Provision an account.
- Enable auditing on the CTERA Edge Filer.
- Enable Messaging and Edge Filer Syslog services on the CTERA Portal.

## Provision Account

Netwrix Activity Monitor uses the CTERA Portal API to retrieve information about portals, Edge Filers, their auditing configurations, and optionally to enable syslog forwarding automatically. To access the API, Activity Monitor requires an account in the CTERA Portal with the __Read Only Administrator__ role.

__Step 1 –__ Log in to the CTERA Portal web interface. In the global administration view, select __Users__ > __Administrators__.

__Step 2 –__ Click New Admin, specify a username, password, email, and the __Read Only Administrator__ role.

This credential will then be used when configuring the Activity Monitor Agent to monitor the CTERA portal.

## Enable Auditing on CTERA Edge Filer

The CTERA Edge Filer can generate audit log events for the SMB access. Audit events are stored in a local file and then forwarded to the CTERA Portal for further processing. The audit log is disabled by default and must be enabled.

Follow the steps to enable SMB audit logs.

__Step 1 –__ Log in to the Edge Filer web interface. In the Configuration view, select __Logs__ > __Audit Logs__.

__Step 2 –__ Select the __Enable CIFS/SMB Audit Logs__ option.

__Step 3 –__ Specify a share to save the audit logs in the Save log files option. If a share does not exist, create a new one first.

__NOTE:__ CTERA recommends that SMB Audit logging is saved to a folder that is local on the Edge Filer and not synced to the cloud. For example, in the root of vol1, which can then be used to create a share.

__Step 4 –__ Adjust the __Keep closed files for__ parameter. Otherwise, use the default value.

__Step 5 –__ Check all events except the __Read Extended Attributes__ event in Events to log list. If you do not require monitoring of _Directory Read/List_ operations, which typically generate a high volume of data, uncheck the __List Folder Read Data__ event.

__Step 6 –__ Make sure that __Log permission changes in human readable format__ is unchecked.

__Step 7 –__ Click __Save__.

To verify that the auditing is enabled, generate some file activity and check the share specified in __Step 3__. An audit log should be created in ```audit.log.dir/audit.log```.

See the [Auditing SMB File Access](https://kb.ctera.com/docs/auditing-smb-file-access-5) article in the CTERA Edge Filer Administrator Guide for additional information.

## Enable Services on CTERA Portal

The following services must be enabled and configured on the CTERA Portal:

- CTERA Messaging Service -– Enables sending notifications to various consumers, including the Edge Filer Syslog service.
- CTERA Edge Filer Syslog Service – Consolidates audit events from Edge Filers and sends them to the Activity Monitor Agent and other consumers.

Both services are disabled by default and must be enabled. The Messaging service must be enabled first.

### Enable the Messaging Service

See the [Managing the CTERA Messaging Service](https://kb.ctera.com/docs/managing-the-ctera-messaging-service-2) article in the CTERA Portal Global Administrator Guide for additional information on requirements and recommendations for production and POC environments.

__Step 1 –__ Before setting up the Messaging Service in the web interface, first initialize the messaging components with the following CLI command:

set /settings/platformServicesSetting/enabled true

Initialization takes a few minutes.

__Step 2 –__ Log in to the CTERA Portal web interface. In the global administration view, select __Services__ > __Messaging__.

__Step 3 –__ To add a new messaging server, click __Add Messaging Servers__. Select the servers to use as messaging servers. Click __Save__.

__NOTE:__ In a production environment, designate three servers as messaging servers. In a small or test environment, CTERA supports using a single messaging server, typically the main database server. However, in all other cases, exactly three servers must be assigned as messaging servers.  
See the [Managing the CTERA Messaging Service](https://kb.ctera.com/docs/managing-the-ctera-messaging-service-2) article for additional information.

__Step 4 –__ Deploying the messaging service takes a few minutes. The status will change to STARTING and then to ACTIVE. Wait until the status is ACTIVE before proceeding to the next step.

__NOTE:__ If the status does not change to ACTIVE, the log files need to be collected from ```/usr/local/lib/ctera/work/logs/services``` directory.   
See the [CTERA Messaging Service Logs](https://kb.ctera.com/docs/setting-up-the-ctera-messaging-service-2#CTERA-Messaging-Service-Logs) article for additional information.

### Enable the Edge Filer Syslog Service

Ensure the [Enable the Messaging Service](#Enable-the-Messaging-Service) section is completed before proceeding to enable the Syslog Service.

The Edge Filer Syslog Service can be configured in two ways:

- Automatically by the Activity Monitor using the API from CTERA Portal.
- Manually using the CTERA Portal web interface.

It is recommended to configure the service automatically. With automatic configuration, the Activity Monitor Agent will apply the settings and perform periodic checks to ensure correctness. To enable automatic configuration, use the __Enable Edge Filer Syslog auditing__ option in the host properties and specify credentials to access the CTERA Portal API.

Follow the steps to configure the Edge Filer Syslog Service manually.

__Step 1 –__ Configure monitoring of the CTERA Portal in the Activity Monitor Console.

__Step 2 –__  Add a CTERA host on the Monitored Hosts page and specify the portal host name, username, password, and complete the wizard.

__Step 3 –__ Enable the newly added host.

__Step 4 –__ Copy a TLS certificate file, ```certca.pem```, from ```%ProgramData%\Netwrix\Activity Monitor\Agent\Data``` folder on the agent's server.

__Step 5 –__ Log in to the CTERA Portal web interface. In the global administration view, select __Services__ > __Edge Filer Syslog__.

__Step 6 –__ Click __Add a Server__.

__Step 7 –__ Specify the __FQDN of the agent__ or __IP address__ in the Addressfield.

__Step 8 –__ Specify 4488 in the Port field.

__NOTE:__ The default port can be changed in the properties of the agent on the CTERA page.

__Step 9 –__ Change the protocol to __TCP/TLS__.

__Step 10 –__ Click __Server Certificate__ > __Select File__ to upload the file collected at Step 2.

__Step 11 –__ Click __Save__.

__Step 12 –__ Click __Enable__ in the status bar.

The status will change to STARTING. If the CTERA Portal manages to connect to the Activity Monitor Agent, the status changes to ACTIVE. If not, review the error message and check __Logs & Alerts__ > __System Log__ for details.

See the [Managing the Edge Filer Syslog Service](https://kb.ctera.com/docs/managing-the-edge-filer-syslong-service) article in the CTERA Portal Global Administrator Guide for additional information.
