# SP\_RegisterAzureAppAuth Job

SP\_RegisterAzureAppAuth will register an Microsoft Entra ID (formerly Azure AD) application for authentication and provision appropriate permissions for SharePoint Online scans. It requires:

- A Connection Profile containing the following two user credentials, both with an Account Type of __Task (Local)__:

  - Microsoft Entra ID Global Admin credential
  - A credential with the username ```newapp``` that contains the password for the new application
- Microsoft Graph API PowerShell module to be installed on targeted hosts

## Instantiate the SP\_RegisterAzureAppAuth Job.

Follow the steps to instantiate the SP\_RegisterAzureAppAuth Job.

__Step 1 –__ In Access Analyzer navigate to the SharePoint Job Group (or any other Job Group you wish to place the SP\_RegistureAzureApp job into).

__Step 2 –__ Click __Add Instant Job__ to open the Instant Job Wizard.

__Step 3 –__ Install the SP\_RegisterAzureAppAuth Job from the Instant Job Library under the SharePoint library. After installation, the job tree automatically refreshes with the new job available within the selected Job Group.

__Step 4 –__ On the job description page, in the Configuration section, select the edit button for __The new application’s display name__ and enter the name you want to apply to the registered Microsoft Entra ID application. Click __Save__.

__Step 5 –__ On the __Configure__ > __Hosts__ node, select the targeted host. The targeted host should be the Microsoft Entra ID tenant on which you want to install the Microsoft Entra ID application (for example, ```myorg.onmicrosoft.com```). Click __Save__. The job is now ready to be run.

After the job successfully runs it will open a browser window to Microsoft Entra ID that, when logged-in as a Global Administrator, allows the user to grant administrator consent to the Application's configured API Permissions. If the login attempt fails, or the user closes the browser, they will need to login to Microsoft Entra ID as a Global Administrator and navigate to the Application's API Permissions to grant Admin Consent before the Application can be used for SharePoint scans in Access Analyzer.

Additional Considerations

- After the job successfully runs, there will be a new Connection Profile for this Application. Restart the Access Analyzer Console and enter a password to use this Connection Profile.
- The password is the location of the PFX file generated by the script (in the \PrivateAssemblies directory), the Microsoft Entra ID application's password, and a numeric designator for the Microsoft 365 environment (0 is the default for production environments; the other supported options are 1 for pre-production environments, 2 for China, 3 for Germany, 4 for US Government, 5 for US Government-High, and 6 for US Government-DoD). To allow for multiple unique certificates for different Microsoft Entra ID tenants to be stored on the same Access Analyzer server, the script appends the targeted host name (without the domain) to the filename of the PFX file generated by the script. For example, if the targeted host is ```myorg.onmicrosoft.com```, then the password for the connection profile would be:

  ...\STEALTHbits\StealthAUDIT\PrivateAssemblies\spaa\_cert\_myorg.pfx,YourPasswordHere,0
